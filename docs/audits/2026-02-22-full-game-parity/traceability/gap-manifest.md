# Gap Manifest (Canonical)

Each row should be closable by one feature-sized commit.

## Schema
- `gap_id`
- `domain`
- `java_class`
- `java_method_or_path`
- `python_file`
- `python_symbol`
- `status` (`exact|approximate|missing|action-surface-missing`)
- `rng_streams`
- `decision_surface` (`explicit_action|implicit_ui|n/a`)
- `existing_tests`
- `required_tests`
- `priority`
- `feature_id`
- `planned_pr_region`
- `notes`

## Active rows

| gap_id | domain | java_class | java_method_or_path | python_file | python_symbol | status | rng_streams | decision_surface | existing_tests | required_tests | priority | feature_id | planned_pr_region | notes |
|---|---|---|---|---|---|---|---|---|---|---|---|---|---|---|
| GAP-REL-001 | relics | `Orrery` | `relics/Orrery.java::onEquip` | `packages/engine/state/run.py`, `packages/engine/game.py` | `_on_relic_obtained`, `take_action_dict` | exact | `card_rng` | explicit_action | `tests/test_relic_pickup.py`, `tests/test_agent_api.py::test_shop_orrery_requires_card_selection`, `tests/test_agent_api.py::test_shop_orrery_selection_roundtrip_adds_five_cards`, `tests/test_agent_api.py::test_reward_orrery_requires_card_selection` | regression lock for deterministic IDs/validation | P0 | REL-003 | R1 | fixed: explicit follow-up `select_cards` with valid one-per-offer combinations |
| GAP-REL-002 | relics | `BottledFlame/Lightning/Tornado` | `relics/Bottled*.java::onEquip` | `packages/engine/state/run.py`, `packages/engine/game.py` | `_on_relic_obtained`, `take_action_dict` | exact | n/a | explicit_action | `tests/test_relic_bottled.py`, `tests/test_agent_api.py::test_shop_bottled_flame_requires_card_selection`, `tests/test_agent_api.py::test_shop_bottled_flame_selection_roundtrip_sets_card`, `tests/test_agent_api.py::test_reward_bottled_lightning_requires_card_selection` | regression lock for deterministic selection IDs | P0 | REL-004 | R1 | fixed: reward/shop flows emit explicit selection and apply selected bottled card |
| GAP-REL-003 | relics | `DollysMirror` | `relics/DollysMirror.java::onEquip` | `packages/engine/state/run.py`, `packages/engine/game.py` | `_on_relic_obtained`, `take_action_dict` | exact | n/a | explicit_action | `tests/test_relic_pickup.py`, `tests/test_agent_api.py::test_shop_dollys_mirror_requires_card_selection`, `tests/test_agent_api.py::test_shop_dollys_mirror_roundtrip_duplicates_selected_card`, `tests/test_agent_api.py::test_reward_dollys_mirror_requires_card_selection` | regression lock for deterministic selection IDs | P0 | REL-008 | R1 | fixed: reward/shop flows emit explicit deck-card selection and duplicate selected card |
| GAP-REL-005 | relics | selection action determinism | deterministic action surface for equivalent snapshots | `packages/engine/game.py` | `_selection_context_actions`, `_apply_pending_relic_selection` | exact | `card_rng` | explicit_action | `tests/test_agent_api.py::test_orrery_selection_candidates_have_deterministic_ids`, `tests/test_agent_api.py::test_orrery_rejects_invalid_selection_combination`, `tests/test_agent_api.py::test_bottled_selection_rejects_invalid_card_index` | none | P1 | REL-005 | R1 | fixed: deterministic IDs validated and invalid selection payloads rejected |
| GAP-EVT-001 | events | multiple card-select events | `events/**` choice flows | `packages/engine/game.py` | `take_action_dict` + pending selection plumbing | exact | `event_rng,misc_rng` | explicit_action | `tests/test_agent_api.py::test_event_choice_requires_selection_without_state_mutation` | none | P0 | EVT-001 | R2 | fixed: event choices now emit explicit follow-up `select_cards` actions via pending selection context |
| GAP-EVT-002 | events | multiple | `events/** execute with selected card` | `packages/engine/game.py` | `_handle_event_action` | exact | `event_rng,misc_rng` | explicit_action | `tests/test_agent_api.py::test_event_choice_selection_roundtrip_uses_selected_card_index` | none | P0 | EVT-002 | R2 | fixed: selected card indices are validated and passed through to `execute_choice(..., card_idx=...)` |
| GAP-EVT-003 | events | `GoldenIdol` (multi-phase reference) | `events/exordium/GoldenIdolEvent.java` phase transitions | `packages/engine/game.py`, `tests/test_agent_api.py` | `take_action_dict`, `get_available_action_dicts` | exact | `event_rng,misc_rng` | explicit_action | `tests/test_agent_api.py::test_event_multiphase_golden_idol_keeps_event_phase_and_updates_choices`, `tests/test_agent_api.py::test_event_multiphase_golden_idol_followup_action_ids_are_deterministic` | none | P1 | EVT-003 | R2 | fixed: deterministic multi-phase action-surface coverage added at runner level |
| GAP-EVT-004 | events | Java class-name aliases | `events/**/*.java` class names vs canonical IDs | `packages/engine/handlers/event_handler.py`, `tests/test_audit_events.py` | `EVENT_ID_ALIASES`, `_normalize_event_id` | exact | n/a | n/a | `tests/test_audit_events.py::TestEventAliasNormalization::test_java_aliases_normalize_to_canonical_ids` | none | P1 | EVT-004 | R2 | fixed: Java alias variants map to canonical Python event IDs |
| GAP-RWD-001 | rewards | multiple reward action types | reward availability surface | `packages/engine/game.py` | `_get_reward_actions`, `_reward_handler_action_to_game_action` | exact | n/a | explicit_action | `tests/test_agent_api.py::test_reward_action_surface_matches_reward_handler` | none | P1 | RWD-001 | R3 | fixed: runner reward action emission now derives from `RewardHandler.get_available_actions` |
| GAP-RWD-002 | rewards | multiple reward action types | reward action execution | `packages/engine/game.py`, `packages/engine/handlers/reward_handler.py` | `_handle_reward_action`, `_game_reward_action_to_handler_action`, `RewardHandler.handle_action` | exact | `card_rng,relic_rng,misc_rng,potion_rng` | explicit_action | `tests/test_agent_api.py::test_claim_gold_returns_error_when_already_claimed` | none | P1 | RWD-002 | R3 | fixed: runner claim/skip execution now routes through `RewardHandler` and surfaces handler errors |
| GAP-RWD-003 | rewards | reward proceed gating | proceed transition invariants | `packages/engine/game.py` | `_handle_reward_action` proceed branch | exact | n/a | explicit_action | `tests/test_agent_api.py::test_proceed_from_rewards_fails_with_unresolved_card_reward`, `tests/test_agent_api.py::test_proceed_from_rewards_fails_with_unresolved_relic_reward` | modifier-specific coverage (`RWD-004`) | P1 | RWD-003 | R3 | fixed: proceed now validates unresolved mandatory rewards and preserves boss-fight transition path |
| GAP-RWD-004 | rewards | `BlackStar`, `RewardItem` | secondary relic claim/gating in reward screen | `packages/engine/handlers/reward_handler.py`, `packages/engine/game.py` | `ClaimRelicAction(reward_index)`, reward adapters | exact | n/a | explicit_action | `tests/test_agent_api.py::test_reward_actions_include_second_relic_claim_index`, `tests/test_agent_api.py::test_claim_second_relic_by_index`, `tests/test_agent_api.py::test_proceed_blocked_until_second_relic_claimed` | none | P1 | RWD-004 | R3 | fixed: indexed claim actions now include both primary and secondary relic rewards |
| GAP-REL-004 | relic IDs | `Toolbox`, class-name alias IDs | `relics/Toolbox.java`, `helpers/RelicLibrary.java` | `packages/engine/content/relics.py`, `packages/engine/state/run.py` | `ALL_RELICS`, `resolve_relic_id`, `_canonical_relic_id` | exact | n/a | n/a | `tests/test_relic_aliases.py`, `tests/test_relic_pickup.py` | none | P1 | REL-006 | R1 | fixed: added `Toolbox` (`SHOP`) and shared canonical alias resolution for Java/class-name forms |
| GAP-REL-006 | relic ordering/context | `BurningBlood`, `BlackBlood`, `MeatOnTheBone`, `BloodVial`, `PreservedInsect`, `Sling`, `Pantograph`, `SlaversCollar` | `relics/*.java::onVictory|atBattleStart|atTurnStart` | `packages/engine/game.py`, `packages/engine/registry/relics.py`, `packages/engine/state/combat.py`, `tests/test_audit_relics_combat.py` | `_trigger_post_combat_relics`, `_end_combat`, `preserved_insect_start`, `CombatState` | exact | n/a | n/a | `tests/test_relic_ordering_rel007.py`, `tests/test_audit_relics_combat.py` | none | P1 | REL-007 | R1 | fixed: no duplicate fallback onVictory application, fallback thresholds corrected, Blood Vial fallback removed, Preserved Insect elite reduction fixed, combat_type context stabilized |
| GAP-CRD-INV-001 | cards | core card inventory | `cards/{red,green,purple,colorless,curses,status,blue}/*.java` (excluding deprecated/option/temp) | `packages/engine/content/cards.py` | `ALL_CARDS` | approximate | mixed | explicit_action | character card suites + card audit suites | manifest rows + alias policy + targeted parity tests | P1 | CRD-INV-001 | R4 | Java core IDs `361`, raw key overlap `360`; lookup-resolved overlap `361/361` after `CRD-INV-002` (`Discipline` + `Impulse` implemented, `Gash` alias to `Claw`); non-Defect unresolved-effect rows remain `23` |
| GAP-CRD-SH-001 | cards | shared curse/status runtime effects | `cards/status/*.java`, `cards/curses/*.java`, relevant colorless runtime behavior | `packages/engine/effects/cards.py`, `packages/engine/handlers/combat.py` | end-of-turn curse/status effect handlers + `_trigger_end_of_turn_hand_cards` | exact | n/a | n/a | `tests/test_effects_and_combat.py` end-turn/draw tests | none | P1 | CRD-SH-001 | R4 | fixed: Burn/Decay/Doubt/Shame/Regret/Pride end-of-turn runtime effects + Void draw energy loss are now engine-executed and test-locked |
| GAP-POW-001 | powers | multiple | `powers/**/*.java` inventory | `packages/engine/content/powers.py` | `POWER_DATA` | missing | mixed | n/a | power audit tests | per-class inventory + behavior tests | P1 | POW-001 | R5 | 149 Java classes vs 94 Python entries; 69 normalized gap candidates |
| GAP-ORB-001 | orbs | `AbstractPlayer`, `ImpulseAction`, `LoopPower`, orb-linked relic classes | `characters/AbstractPlayer.java::channelOrb/evokeOrb/applyStartOfTurnOrbs`, `actions/defect/ImpulseAction.java`, `relics/{CrackedCore,NuclearBattery,SymbioticVirus,GoldPlatedCables,FrozenCore,EmotionChip,Inserter}.java` | `packages/engine/effects/orbs.py`, `packages/engine/registry/relics.py`, `packages/engine/combat_engine.py`, `packages/engine/handlers/combat.py`, `packages/engine/registry/__init__.py`, `packages/engine/state/combat.py`, `packages/engine/registry/potions.py` | orb runtime + orb-linked relic handlers + combat turn integration | exact | `card_rng,card_random_rng,relic_rng` | n/a | `tests/test_orb_runtime_orb001.py`, `tests/test_defect_cards.py`, `tests/test_relic_triggers_combat.py` | maintain strict orb runtime integration tests + deterministic RNG assertions | P1 | ORB-001 | R5 | closed: start-turn orb passives wired; alias-safe relic trigger dispatch deduped; placeholder orb branches removed from active handlers; full suite green (`4676 passed, 5 skipped`) |
| GAP-RNG-001 | determinism | multiple systems | RNG stream ownership parity | `packages/engine/**` | direct `random` usage callsites | approximate | mixed | n/a | baseline determinism tests | replace direct `random` with owned streams + add stream advancement tests | P1 | CONS-001B | R5 | static scan shows 23 direct Python `random` callsites in engine modules after `CONS-001` |
| GAP-RWD-005 | rewards | monster kill dependent reward tuning | combat result -> reward generation bridge | `packages/engine/game.py` | `_end_combat` (`enemies_killed = 1`) | approximate | n/a | n/a | reward baseline tests | derive enemy kill count from combat result and lock with tests | P2 | CONS-005 | R7 | placeholder value can diverge from Java behavior in multi-enemy fights |
| GAP-TST-001 | tests | n/a | audit assertions should enforce parity | `tests/test_audit_damage.py` | bug-documentation tests | approximate | n/a | n/a | current audit tests | convert bug-documentation checks into parity assertions after behavior fixes | P1 | AUD-001 | R7 | at least one audit file still documents known bug behavior instead of enforcing Java-correct output |
| GAP-CI-001 | testing/ci | n/a | replay artifact dependency | `tests/test_parity.py` | replay checks | approximate | n/a | n/a | baseline run | split artifact tests from normal CI profile | P2 | AUD-002 | R7 | current baseline includes 5 artifact-missing skips |
| GAP-POT-001 | audit-inventory | potion classes | `potions/*.java` not present in local decompile snapshot | `docs/audits/.../traceability/java-inventory.md` | inventory intake | missing | n/a | n/a | n/a | restore source or reference list | P2 | AUD-001 | R7 | local Java snapshot lacks dedicated potion class directory |
